name: C# CodeQL Analysis

on:
  workflow_call:
    inputs:
      nuget_feed_name:
        required: true
        type: string
      nuget_feed_source:
        required: true
        type: string
      nuget_config:
        required: true
        type: string

jobs:
  analyze:
    name: Analyze
    runs-on: windows-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        config-file: codeql-config.yml
        languages: 'csharp'
    
    - name: Initialize cache
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}

    - name: Remove default Azure DevOps NuGet feed
      run: dotnet nuget remove source ${{ inputs.nuget_feed_name }} --configfile ${{ inputs.nuget_config }}
    
    - name: Add UW Health Azure DevOps NuGet feed
      run: dotnet nuget add source ${{ inputs.nuget_feed_source }} -n ${{ inputs.nuget_feed_name }} -u az -p ${{ secrets.AZURE_DEVOPS_TOKEN }}

    - name: Restore NuGet packages
      run: dotnet restore --configfile ${{ inputs.nuget_config }}    
    
    - name: Restore npm packages
      run: cd ${{ inputs.projectname }} && npm install

    - name: Build
      run: dotnet build --configuration Release

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2      
