name: SonarCloud Analysis

on:
  workflow_call:
    inputs:
      project_name:
        required: true
        type: string
    secrets:
      sonar_token:
        required: true
      github_token:
        required: true

jobs:
  SonarCloud:
    name: SonarCloud
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
    - name: Download Artifact
      uses: actions/download-artifact@v3.0.0
      with:
        name: work
        
    - name: Unzip Artifact
      run: 7z x work.zip       
          
    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@v1.6
      with:        
        projectBaseDir: ${{ inputs.project_name }}
        args: >  
          -Dsonar.organization=uwhealth-is
          -Dsonar.projectKey=${{ inputs.project_name }}-UWHealth-is
          -Dsonar.exclusions=**/*.bin,**/obj/**,**/wwwroot/dist/**,**/wwwroot/lib/**,**/Migrations/**/*
          -Dsonar.coverage.exclusions=**/Startup.cs,**/Program.cs,**/wwwroot/**/*.js,**/*Tests.cs
          -Dsonar.cs.cobertura.reportsPaths=**/coverage.cobertura.xml
          -Dsonar.verbose=false
      env:
        GITHUB_TOKEN: ${{ secrets.github_token }}
        SONAR_TOKEN: ${{ secrets.sonar_token }}
