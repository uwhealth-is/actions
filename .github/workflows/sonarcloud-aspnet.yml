name: SonarCloud Scan

on:
  workflow_call:
    inputs:
      project_name:
        required: true
        type: string
    secrets:
      sonar_token:
        required: true

jobs:
  SonarCloud:
    name: SonarCloud
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
    - name: Download Build Artifact
      uses: actions/download-artifact@v3
      with: 
        name: Build-${GITHUB_RUN_ID}
      
    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@v1.6
      with:        
        projectBaseDir: ${{ inputs.projectname }}
        args: >  
          -Dsonar.organization=uwhealth
          -Dsonar.projectKey=${{ inputs.projectname }}-UWHealth
          -Dsonar.exclusions=**/*.bin,**/obj/**,**/wwwroot/dist/**,**/wwwroot/lib/**,**/Migrations/**/*
          -Dsonar.coverage.exclusions=**/Startup.cs,**/Program.cs,**/wwwroot/**/*.js,**/*Tests.cs
          -Dsonar.cs.cobertura.reportsPaths=**/coverage.cobertura.xml
          -Dsonar.verbose=false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
