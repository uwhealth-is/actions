name: Aspnetcore Build & Test

on:
  workflow_call:
    inputs:
      project_name:
        required: true
        type: string     
    secrets:
      ado_token:
        required: true
        
jobs:
  analyze:  
    env:
      nuget_feed_name: 'UWHealth'
      nuget_feed_source: 'https://pkgs.dev.azure.com/uwhealth/_packaging/UWHealth_Package_Feed_Updated/nuget/v3/index.json'
      nuget_config: 'Nuget.config'
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Initialize cache
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}

    - name: Remove default Azure DevOps NuGet feed
      run: dotnet nuget remove source ${{ env.nuget_feed_name }} --configfile ${{ env.nuget_config }}
    
    - name: Add UW Health Azure DevOps NuGet feed
      run: dotnet nuget add source ${{ env.nuget_feed_source }} -n ${{ env.nuget_feed_name }} -u az -p ${{ secrets.ado_token }} --configfile ${{ env.nuget_config }} --store-password-in-clear-text

    - name: Restore NuGet packages
      run: dotnet restore --configfile ${{ env.nuget_config }}    
    
    - name: Restore npm packages
      run: cd ${{ inputs.project_name }} && npm install

    - name: Build
      run: dotnet build --configuration Release
      
    - name: Run dotnet test   
      run: dotnet test --no-build --logger trx --configuration Release --collect:"XPlat Code Coverage" --results-directory "TestResults"
    
    - name: Cache Build
      uses: actions/cache@v3
      with:
        path: ${{ inputs.project_name }}/bin/Release/net6.0/**
        key: ${{ runner.os }}-build-${{github.run_id}}
        restore-keys: |
          ${{ runner.os }}-build-  

    - name: Cache Tests
      uses: actions/cache@v3
      with:
        path: TestResults/**
        key: ${{ runner.os }}-tests-${{github.run_id}}
        restore-keys: |
          ${{ runner.os }}-tests- 
